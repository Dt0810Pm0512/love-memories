<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‡´æˆ‘çš„ä¹–ä¹– - ä¸“å±çˆ±æƒ…çºªå¿µå†Œ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#FF6B9D',
                        secondary: '#C44569',
                        accent: '#F8B500',
                        love: {
                            50: '#FFF0F5',
                            100: '#FFE4E6',
                            200: '#FFB6C1',
                            300: '#FF69B4',
                            400: '#FF1493',
                            500: '#DA70D6',
                            600: '#DDA0DD',
                            700: '#9370DB',
                            800: '#8A2BE2',
                            900: '#9932CC'
                        }
                    },
                    fontFamily: {
                        romantic: ['Georgia', 'serif'],
                        elegant: ['Inter', 'sans-serif']
                    },
                    animation: {
                        'float': 'float 6s ease-in-out infinite',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'bounce-slow': 'bounce 2s infinite',
                        'glow': 'glow 2s ease-in-out infinite alternate',
                        'celebrate': 'celebrate 0.6s ease-out',
                        'sparkle': 'sparkle 1.5s ease-in-out infinite',
                        'fadeInUp': 'fadeInUp 0.8s ease-out',
                        'scaleIn': 'scaleIn 0.5s ease-out',
                        'heartExplosion': 'heartExplosion 0.8s ease-out',
                        'floatHeart': 'floatHeart 3s ease-in-out infinite',
                        'rotate3d': 'rotate3d 20s linear infinite',
                        'pulseGlow': 'pulseGlow 2s ease-in-out infinite',
                        'wave': 'wave 1s ease-in-out infinite'
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .gradient-love {
                background: linear-gradient(135deg, #FF6B9D 0%, #C44569 50%, #9B59B6 100%);
            }
            .gradient-text {
                background: linear-gradient(135deg, #FF6B9D, #9B59B6);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                background-clip: text;
            }
            .glass-effect {
                background: rgba(255, 255, 255, 0.1);
                backdrop-filter: blur(10px);
                border: 1px solid rgba(255, 255, 255, 0.2);
            }
            .text-shadow {
                text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            }
            .hover-lift {
                transition: transform 0.3s ease, box-shadow 0.3s ease;
            }
            .hover-lift:hover {
                transform: translateY(-8px);
                box-shadow: 0 20px 40px rgba(255, 107, 157, 0.3);
            }
        }
        
        @keyframes heartbeat {
            0% { transform: scale(1); }
            14% { transform: scale(1.1); }
            28% { transform: scale(1); }
            42% { transform: scale(1.1); }
            70% { transform: scale(1); }
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-20px); }
        }
        
        @keyframes glow {
            0% { box-shadow: 0 0 20px rgba(255, 107, 157, 0.5); }
            100% { box-shadow: 0 0 30px rgba(255, 107, 157, 0.8), 0 0 40px rgba(255, 107, 157, 0.3); }
        }
        
        @keyframes celebrate {
            0% { transform: scale(0.5); opacity: 0; }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); opacity: 1; }
        }
        
        @keyframes sparkle {
            0%, 100% { transform: scale(1) rotate(0deg); }
            50% { transform: scale(1.2) rotate(180deg); }
        }
        
        @keyframes fadeInUp {
            0% { transform: translateY(30px); opacity: 0; }
            100% { transform: translateY(0); opacity: 1; }
        }
        
        @keyframes scaleIn {
            0% { transform: scale(0); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        @keyframes heartExplosion {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.5); opacity: 0.8; }
            100% { transform: scale(2); opacity: 0; }
        }
        
        @keyframes floatHeart {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-15px) rotate(5deg); }
        }
        
        @keyframes rotate3d {
            0% { transform: rotateX(0deg) rotateY(0deg); }
            100% { transform: rotateX(360deg) rotateY(360deg); }
        }
        
        @keyframes pulseGlow {
            0%, 100% { box-shadow: 0 0 5px rgba(255, 107, 157, 0.5); }
            50% { box-shadow: 0 0 20px rgba(255, 107, 157, 0.8); }
        }
        
        @keyframes wave {
            0%, 100% { transform: scaleX(1); }
            50% { transform: scaleX(1.1); }
        }
        
        .heartbeat {
            animation: heartbeat 1.5s ease-in-out infinite;
        }
        
        .delete-btn {
            opacity: 1 !important;
            transition: all 0.3s ease;
            animation: pulseGlow 2s ease-in-out infinite;
        }
        
        .delete-btn:hover {
            transform: scale(1.2);
            background-color: #ef4444 !important;
            animation: none;
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.6);
        }
        
        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡ */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #FF6B9D, #9B59B6);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #C44569, #8A2BE2);
        }
        
        /* æ¯›ç»ç’ƒæ•ˆæœ */
        .glass-card {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }
        
        /* æ¸å˜èƒŒæ™¯ */
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .gradient-bg-love {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        .gradient-bg-sunset {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-love-50 via-white to-love-100 font-elegant">
    <!-- æµ®åŠ¨çˆ±å¿ƒç²’å­ -->
    <div id="loveParticles" class="fixed inset-0 pointer-events-none z-50"></div>
    
    <!-- å¯¼èˆªæ  -->
    <nav class="glass-card fixed top-0 left-0 right-0 z-40 px-6 py-4">
        <div class="max-w-7xl mx-auto flex items-center justify-between">
            <div class="flex items-center space-x-3">
                <div class="text-2xl text-primary animate-pulse-slow">ğŸ’•</div>
                <h1 class="text-xl font-bold gradient-text">è‡´æˆ‘çš„ä¹–ä¹–</h1>
            </div>
            
            <div class="flex items-center space-x-4">
                <!-- åŒæ­¥çŠ¶æ€å¾½ç«  -->
                <div id="syncBadge" class="hidden px-3 py-1 bg-green-500 text-white text-xs rounded-full animate-pulse">âœ“</div>
                
                <!-- åŒæ­¥æŒ‰é’® -->
                <button onclick="syncAllData()" class="p-2 text-primary hover:text-secondary transition-colors duration-300" title="åŒæ­¥æ•°æ®">
                    <i class="fa fa-refresh"></i>
                </button>
                
                <!-- çŠ¶æ€ä¿¡æ¯æŒ‰é’® -->
                <button onclick="window.syncStatus.showStatus()" class="p-2 text-primary hover:text-secondary transition-colors duration-300" title="æŸ¥çœ‹çŠ¶æ€">
                    <i class="fa fa-info-circle"></i>
                </button>
                
                <!-- ä¸»é¢˜åˆ‡æ¢æŒ‰é’® -->
                <button onclick="toggleTheme()" class="p-2 text-primary hover:text-secondary transition-colors duration-300" title="åˆ‡æ¢ä¸»é¢˜">
                    <i class="fa fa-moon-o"></i>
                </button>
            </div>
        </div>
    </nav>
    
    <!-- ä¸»å†…å®¹åŒº -->
    <main class="pt-24 pb-16 px-4">
        <div class="max-w-7xl mx-auto">
            
            <!-- çˆ±æƒ…è®¡æ—¶å™¨åŒºåŸŸ -->
            <section id="timerSection" class="hidden mb-16 text-center">
                <div class="glass-card rounded-3xl p-8 md:p-12 animate-fadeInUp">
                    <h2 class="text-4xl md:text-6xl font-bold gradient-text mb-8 animate-pulse-slow">
                        æˆ‘ä»¬å·²ç»ç›¸çˆ±äº†
                    </h2>
                    
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-6 mb-8">
                        <div class="glass-effect rounded-2xl p-6 animate-scaleIn">
                            <div id="days" class="text-3xl md:text-5xl font-bold text-primary mb-2">0000</div>
                            <div class="text-sm text-gray-600">å¤©</div>
                        </div>
                        <div class="glass-effect rounded-2xl p-6 animate-scaleIn" style="animation-delay: 0.1s">
                            <div id="hours" class="text-3xl md:text-5xl font-bold text-primary mb-2">00</div>
                            <div class="text-sm text-gray-600">æ—¶</div>
                        </div>
                        <div class="glass-effect rounded-2xl p-6 animate-scaleIn" style="animation-delay: 0.2s">
                            <div id="minutes" class="text-3xl md:text-5xl font-bold text-primary mb-2">00</div>
                            <div class="text-sm text-gray-600">åˆ†</div>
                        </div>
                        <div class="glass-effect rounded-2xl p-6 animate-scaleIn" style="animation-delay: 0.3s">
                            <div id="seconds" class="text-3xl md:text-5xl font-bold text-primary mb-2">00</div>
                            <div class="text-sm text-gray-600">ç§’</div>
                        </div>
                    </div>
                    
                    <div class="text-lg text-gray-600 mb-8">
                        <span id="loveDate"></span> è‡³ä»Š
                    </div>
                    
                    <div class="flex justify-center space-x-4">
                        <button onclick="pauseTimer()" id="pauseBtn" class="px-6 py-3 bg-orange-500 text-white rounded-full hover:bg-orange-600 transition-colors duration-300">
                            <i class="fa fa-pause mr-2"></i>æš‚åœ
                        </button>
                        <button onclick="resumeTimer()" id="resumeBtn" class="hidden px-6 py-3 bg-green-500 text-white rounded-full hover:bg-green-600 transition-colors duration-300">
                            <i class="fa fa-play mr-2"></i>ç»§ç»­
                        </button>
                        <button onclick="resetTimer()" class="px-6 py-3 bg-red-500 text-white rounded-full hover:bg-red-600 transition-colors duration-300">
                            <i class="fa fa-bullseye mr-2"></i>é‡ç½®
                        </button>
                    </div>
                </div>
            </section>
            
            <!-- è¡¨ç™½åŒºåŸŸ -->
            <section id="proposalSection" class="mb-16 text-center">
                <div class="glass-card rounded-3xl p-8 md:p-12 animate-fadeInUp">
                    <div class="text-6xl md:text-8xl mb-8 animate-bounce-slow">ğŸ’•</div>
                    <h2 class="text-3xl md:text-5xl font-bold gradient-text mb-6">äº²çˆ±çš„ä¹–ä¹–</h2>
                    <p class="text-lg md:text-xl text-gray-600 mb-8 leading-relaxed">
                        ä»é‡è§ä½ çš„é‚£ä¸€åˆ»èµ·<br>
                        æˆ‘çš„ä¸–ç•Œå°±å……æ»¡äº†è‰²å½©<br>
                        æ„¿æ„å’Œæˆ‘ä¸€èµ·å¼€å§‹è¿™æ®µç¾å¥½çš„æ—…ç¨‹å—ï¼Ÿ
                    </p>
                    
                    <div class="space-y-4">
                        <div class="flex justify-center space-x-4 mb-6">
                            <input type="text" id="yourName" placeholder="è¾“å…¥ä½ çš„åå­—" class="px-4 py-3 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                            <span class="text-xl text-primary">â¤ï¸</span>
                            <input type="text" id="partnerName" placeholder="è¾“å…¥TAçš„åå­—" class="px-4 py-3 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                        </div>
                        
                        <button onclick="startLoveTimer()" class="px-8 py-4 bg-gradient-to-r from-primary to-secondary text-white rounded-full hover:from-secondary hover:to-primary transition-all duration-300 transform hover:scale-105 animate-glow">
                            <i class="fa fa-heart mr-2"></i>æˆ‘æ„¿æ„å’Œä½ åœ¨ä¸€èµ·
                        </button>
                    </div>
                </div>
            </section>
            
            <!-- æ ‡ç­¾é¡µå¯¼èˆª -->
            <div class="flex flex-wrap justify-center gap-4 mb-8">
                <button onclick="showTab('photos')" id="photosTab" class="tab-btn active px-6 py-3 rounded-full transition-all duration-300">
                    <i class="fa fa-camera mr-2"></i>ç”œèœœç›¸å†Œ
                </button>
                <button onclick="showTab('diary')" id="diaryTab" class="tab-btn px-6 py-3 rounded-full transition-all duration-300">
                    <i class="fa fa-book mr-2"></i>çˆ±æƒ…æ—¥è®°
                </button>
                <button onclick="showTab('messages')" id="messagesTab" class="tab-btn px-6 py-3 rounded-full transition-all duration-300">
                    <i class="fa fa-comments mr-2"></i>ç”œèœœç•™è¨€
                </button>
                <button onclick="showTab('anniversaries')" id="anniversariesTab" class="tab-btn px-6 py-3 rounded-full transition-all duration-300">
                    <i class="fa fa-star mr-2"></i>é‡è¦çºªå¿µæ—¥
                </button>
            </div>
            
            <!-- ç”œèœœç›¸å†Œ -->
            <section id="photosTabContent" class="tab-content">
                <div class="glass-card rounded-3xl p-8 mb-8">
                    <div class="flex items-center justify-between mb-8">
                        <h3 class="text-2xl font-bold gradient-text">
                            <i class="fa fa-camera mr-3"></i>ç”œèœœç›¸å†Œ
                        </h3>
                        <button onclick="openPhotoUpload()" class="px-6 py-3 bg-primary text-white rounded-full hover:bg-secondary transition-colors duration-300">
                            <i class="fa fa-plus mr-2"></i>ä¸Šä¼ ç…§ç‰‡
                        </button>
                    </div>
                    
                    <div id="photosGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                        <!-- ç…§ç‰‡å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                        <div class="text-center py-12 text-gray-500">
                            <i class="fa fa-picture-o text-4xl mb-4"></i>
                            <p>è¿˜æ²¡æœ‰ç…§ç‰‡ï¼Œå¿«å»ä¸Šä¼ ç¬¬ä¸€å¼ ç”œèœœå›å¿†å§ï¼</p>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- çˆ±æƒ…æ—¥è®° -->
            <section id="diaryTabContent" class="tab-content hidden">
                <div class="glass-card rounded-3xl p-8 mb-8">
                    <div class="flex items-center justify-between mb-8">
                        <h3 class="text-2xl font-bold gradient-text">
                            <i class="fa fa-book mr-3"></i>çˆ±æƒ…æ—¥è®°
                        </h3>
                        <button onclick="openDiaryEditor()" class="px-6 py-3 bg-primary text-white rounded-full hover:bg-secondary transition-colors duration-300">
                            <i class="fa fa-plus mr-2"></i>å†™æ—¥è®°
                        </button>
                    </div>
                    
                    <div id="diaryEntries" class="space-y-6">
                        <!-- æ—¥è®°å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                        <div class="text-center py-12 text-gray-500">
                            <i class="fa fa-edit text-4xl mb-4"></i>
                            <p>è¿˜æ²¡æœ‰æ—¥è®°ï¼Œå¿«å»è®°å½•ä½ ä»¬çš„çˆ±æƒ…æ•…äº‹å§ï¼</p>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- ç”œèœœç•™è¨€ -->
            <section id="messagesTabContent" class="tab-content hidden">
                <div class="glass-card rounded-3xl p-8 mb-8">
                    <h3 class="text-2xl font-bold gradient-text mb-8">
                        <i class="fa fa-comments mr-3"></i>ç”œèœœç•™è¨€
                    </h3>
                    
                    <!-- ç•™è¨€è¾“å…¥æ¡† -->
                    <div class="mb-8">
                        <div class="flex space-x-4">
                            <input type="text" id="messageSender" placeholder="ä½ çš„æ˜µç§°" class="flex-1 px-4 py-3 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                            <input type="text" id="messageContent" placeholder="æƒ³å¯¹TAè¯´ä»€ä¹ˆ..." class="flex-2 px-4 py-3 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                            <button onclick="sendMessage()" class="px-6 py-3 bg-primary text-white rounded-full hover:bg-secondary transition-colors duration-300">
                                <i class="fa fa-send"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- ç•™è¨€åˆ—è¡¨ -->
                    <div id="messagesList" class="space-y-4 max-h-96 overflow-y-auto">
                        <!-- ç•™è¨€å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                        <div class="text-center py-12 text-gray-500">
                            <i class="fa fa-comment text-4xl mb-4"></i>
                            <p>è¿˜æ²¡æœ‰ç•™è¨€ï¼Œå¿«å»ç»™TAä¸€ä¸ªæƒŠå–œå§ï¼</p>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- é‡è¦çºªå¿µæ—¥ -->
            <section id="anniversariesTabContent" class="tab-content hidden">
                <div class="glass-card rounded-3xl p-8 mb-8">
                    <div class="flex items-center justify-between mb-8">
                        <h3 class="text-2xl font-bold gradient-text">
                            <i class="fa fa-star mr-3"></i>é‡è¦çºªå¿µæ—¥
                        </h3>
                        <button onclick="openAnniversaryEditor()" class="px-6 py-3 bg-primary text-white rounded-full hover:bg-secondary transition-colors duration-300">
                            <i class="fa fa-plus mr-2"></i>æ·»åŠ çºªå¿µæ—¥
                        </button>
                    </div>
                    
                    <div id="anniversariesGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- çºªå¿µæ—¥å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                        <div class="text-center py-12 text-gray-500">
                            <i class="fa fa-calendar text-4xl mb-4"></i>
                            <p>è¿˜æ²¡æœ‰çºªå¿µæ—¥ï¼Œå¿«å»æ·»åŠ é‡è¦çš„æ—¥å­å§ï¼</p>
                        </div>
                    </div>
                </div>
            </section>
            
        </div>
    </main>
    
    <!-- é¡µè„š -->
    <footer class="text-center py-8 text-gray-600">
        <div class="max-w-7xl mx-auto">
            <p class="mb-2">
                <span class="text-primary">ğŸ’•</span> 
                è‡´æˆ‘æœ€çˆ±çš„ä¹–ä¹–ï¼Œæ„¿æˆ‘ä»¬çš„çˆ±æƒ…æ°¸è¿œç”œèœœ <span class="text-primary">ğŸ’•</span>
            </p>
            <p class="text-sm">
                çˆ±æƒ…çºªå¿µå†Œ &copy; 2024 | ç”¨å¿ƒè®°å½•æ¯ä¸€ä¸ªç¾å¥½ç¬é—´
            </p>
        </div>
    </footer>
    
    <!-- æ¨¡æ€æ¡†å®¹å™¨ -->
    <div id="modalContainer" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <!-- æ¨¡æ€æ¡†å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
    </div>
    
    <!-- é€šçŸ¥æç¤º -->
    <div id="notificationContainer" class="fixed top-24 right-4 z-50 space-y-2">
        <!-- é€šçŸ¥å°†é€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ  -->
    </div>
    
    <!-- æ•°æ®åŒæ­¥è„šæœ¬ -->
    <script src="leancloud-proxy.js"></script>
    
    <script>
        // LeanCloudé…ç½® - è¯·åœ¨è¿™é‡Œå¡«å†™æ‚¨çš„LeanCloud App IDå’ŒApp Key
        const LEANCLOUD_CONFIG = {
            appId: 'YOUR_LEANCLOUD_APP_ID',
            appKey: 'YOUR_LEANCLOUD_APP_KEY',
            serverURL: 'https://your-app-id.api.lncldglobal.com'
        };

        // å…¨å±€å˜é‡
        let loveStartDate = null;
        let yourName = 'æˆ‘';
        let partnerName = 'ä¹–ä¹–';
        let timerInterval = null;
        let isTimerRunning = false;
        let isTimerPaused = false;
        let timerOffset = 0;
        let dataSync = null;
        let currentTab = 'photos';

        // åˆå§‹åŒ–åº”ç”¨
        document.addEventListener('DOMContentLoaded', function() {
            initializeLoveParticles();
            initializeDataSync();
            loadSettings();
            checkTimerStatus();
            loadAllData();
            initializeTabs();
            showNotification('æ¬¢è¿æ¥åˆ°æˆ‘ä»¬çš„çˆ±æƒ…å°ç«™ï¼', 'success');
            
            // åˆå§‹åŒ–æ—¥æœŸé€‰æ‹©å™¨ä¸ºä»Šå¤©
            if (document.getElementById('diaryDate')) {
                document.getElementById('diaryDate').value = new Date().toISOString().split('T')[0];
            }
            if (document.getElementById('anniversaryDate')) {
                document.getElementById('anniversaryDate').value = new Date().toISOString().split('T')[0];
            }
            
            // åˆå§‹åŒ–é»˜è®¤å€¼
            if (document.getElementById('messageSender')) {
                document.getElementById('messageSender').value = yourName;
            }
        });

        // åˆå§‹åŒ–æ•°æ®åŒæ­¥ - ä¿®å¤ç‰ˆ
        function initializeDataSync() {
            try {
                console.log('=== Initializing data sync (fixed version) ===');
                
                // é¦–å…ˆå°è¯•ä¿®å¤ç‰ˆLeanCloudåŒæ­¥
                console.log('Trying fixed LeanCloud sync first...');
                
                if (window.initFixedDataSync) {
                    // æ£€æŸ¥æ˜¯å¦é…ç½®äº†LeanCloud
                    if (LEANCLOUD_CONFIG && LEANCLOUD_CONFIG.appId && LEANCLOUD_CONFIG.appKey) {
                        dataSync = window.initFixedDataSync(LEANCLOUD_CONFIG);
                        console.log('FixedDataSync initialized with LeanCloud config');
                        showNotification('æ­£åœ¨åˆå§‹åŒ–æ•°æ®åŒæ­¥æœåŠ¡...', 'info');
                    } else {
                        // å¦‚æœæ²¡æœ‰é…ç½®ï¼Œä½¿ç”¨æœ¬åœ°æ¨¡å¼
                        console.log('LeanCloud config not found, using local mode');
                        dataSync = window.initFixedDataSync({});
                        showNotification('ä½¿ç”¨æœ¬åœ°å­˜å‚¨æ¨¡å¼', 'info');
                    }
                    
                    return;
                }
                
                // å¦‚æœä¿®å¤ç‰ˆä¸å¯ç”¨ï¼Œæ˜¾ç¤ºé”™è¯¯
                console.error('FixedDataSync is not available');
                showNotification('æ•°æ®åŒæ­¥æœåŠ¡åˆå§‹åŒ–å¤±è´¥', 'error');
                
            } catch (error) {
                console.error('Failed to initialize data sync:', error);
                showNotification(`æ•°æ®åŒæ­¥åˆå§‹åŒ–å¤±è´¥ï¼š${error.message}`, 'error');
            }
        }

        // åŒæ­¥æ‰€æœ‰æ•°æ®
        function syncAllData() {
            if (!dataSync) {
                showNotification('æ•°æ®åŒæ­¥æœåŠ¡æœªåˆå§‹åŒ–', 'error');
                return;
            }

            // æ˜¾ç¤ºåŒæ­¥ä¸­çŠ¶æ€
            const syncBadge = document.getElementById('syncBadge');
            if (syncBadge) {
                syncBadge.classList.remove('hidden', 'bg-green-500', 'bg-red-500');
                syncBadge.classList.add('bg-yellow-500');
                syncBadge.textContent = '...';
            }

            dataSync.syncAllData().then(success => {
                // æ›´æ–°åŒæ­¥çŠ¶æ€
                if (syncBadge) {
                    if (success) {
                        syncBadge.classList.remove('bg-yellow-500');
                        syncBadge.classList.add('bg-green-500');
                        syncBadge.textContent = 'âœ“';
                        
                        // 3ç§’åéšè—æˆåŠŸæ ‡å¿—
                        setTimeout(() => {
                            syncBadge.classList.add('hidden');
                        }, 3000);
                    } else {
                        syncBadge.classList.remove('bg-yellow-500');
                        syncBadge.classList.add('bg-red-500');
                        syncBadge.textContent = 'âœ—';
                    }
                }
            });
        }

        // åŠ è½½æ‰€æœ‰æ•°æ®
        function loadAllData() {
            loadPhotos();
            loadDiary();
            loadMessages();
            loadAnniversaries();
        }

        // åˆå§‹åŒ–æ ‡ç­¾é¡µ
        function initializeTabs() {
            const style = document.createElement('style');
            style.textContent = `
                .tab-btn {
                    background: rgba(255, 255, 255, 0.2);
                    color: #666;
                    border: none;
                    font-weight: 500;
                }
                .tab-btn:hover {
                    background: rgba(255, 255, 255, 0.3);
                    transform: translateY(-2px);
                }
                .tab-btn.active {
                    background: linear-gradient(135deg, #FF6B9D, #9B59B6);
                    color: white;
                    box-shadow: 0 4px 15px rgba(255, 107, 157, 0.3);
                }
            `;
            document.head.appendChild(style);
        }

        // æ˜¾ç¤ºæ ‡ç­¾é¡µ
        function showTab(tabName) {
            // æ›´æ–°å½“å‰æ ‡ç­¾
            currentTab = tabName;
            
            // éšè—æ‰€æœ‰æ ‡ç­¾å†…å®¹
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // ç§»é™¤æ‰€æœ‰æ ‡ç­¾æŒ‰é’®çš„æ¿€æ´»çŠ¶æ€
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // æ˜¾ç¤ºé€‰ä¸­çš„æ ‡ç­¾å†…å®¹
            document.getElementById(tabName + 'TabContent').classList.remove('hidden');
            
            // æ¿€æ´»é€‰ä¸­çš„æ ‡ç­¾æŒ‰é’®
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            // æ»šåŠ¨åˆ°é¡¶éƒ¨
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // åˆå§‹åŒ–çˆ±æƒ…ç²’å­æ•ˆæœ
        function initializeLoveParticles() {
            const particles = document.getElementById('loveParticles');
            if (!particles) return;

            // åˆ›å»ºéšæœºæµ®åŠ¨çš„çˆ±å¿ƒç²’å­
            for (let i = 0; i < 15; i++) {
                setTimeout(() => {
                    createFloatingParticle();
                }, i * 1000);
            }

            // å®šæœŸåˆ›å»ºæ–°ç²’å­
            setInterval(createFloatingParticle, 3000);
        }

        // åˆ›å»ºæµ®åŠ¨ç²’å­
        function createFloatingParticle() {
            const particles = document.getElementById('loveParticles');
            if (!particles) return;

            const particle = document.createElement('div');
            const hearts = ['ğŸ’•', 'ğŸ’–', 'ğŸ’˜', 'ğŸ’', 'ğŸ’“', 'ğŸ’—', 'ğŸ’', 'ğŸ’Œ', 'ğŸ’Ÿ'];
            particle.textContent = hearts[Math.floor(Math.random() * hearts.length)];
            
            const size = Math.random() * 20 + 10;
            const left = Math.random() * 100;
            const top = Math.random() * 100;
            const duration = Math.random() * 10 + 10;
            const delay = Math.random() * 5;
            const opacity = Math.random() * 0.6 + 0.2;

            particle.style.cssText = `
                position: absolute;
                left: ${left}%;
                top: ${top}%;
                font-size: ${size}px;
                opacity: ${opacity};
                pointer-events: none;
                animation: float ${duration}s ease-in-out infinite;
                animation-delay: ${delay}s;
                z-index: 1000;
            `;

            particles.appendChild(particle);

            // è‡ªåŠ¨ç§»é™¤
            setTimeout(() => {
                if (particle.parentNode) {
                    particle.style.opacity = '0';
                    particle.style.transition = 'opacity 2s ease-out';
                    setTimeout(() => {
                        if (particle.parentNode) {
                            particle.parentNode.removeChild(particle);
                        }
                    }, 2000);
                }
            }, duration * 1000);
        }

        // æ£€æŸ¥è®¡æ—¶å™¨çŠ¶æ€
        function checkTimerStatus() {
            const savedSettings = localStorage.getItem('loveSiteSettings');
            if (savedSettings) {
                try {
                    const settings = JSON.parse(savedSettings);
                    if (settings.loveStartDate) {
                        const savedDate = new Date(settings.loveStartDate);
                        const now = new Date();
                        
                        // æ£€æŸ¥æ—¥æœŸæ˜¯å¦æœ‰æ•ˆä¸”ä¸æ˜¯æœªæ¥æ—¥æœŸ
                        if (!isNaN(savedDate.getTime()) && savedDate <= now) {
                            loveStartDate = savedDate;
                            yourName = settings.yourName || 'æˆ‘';
                            partnerName = settings.partnerName || 'ä¹–ä¹–';
                            isTimerRunning = true;
                            showTimerSection();
                            startTimer();
                        } else {
                            // æ—¥æœŸæ— æ•ˆæˆ–ä¸ºæœªæ¥æ—¥æœŸï¼Œæ˜¾ç¤ºè¡¨ç™½ç•Œé¢
                            showProposalSection();
                        }
                    } else {
                        showProposalSection();
                    }
                } catch (error) {
                    console.error('Failed to parse settings:', error);
                    showProposalSection();
                }
            } else {
                showProposalSection();
            }
        }

        // æ˜¾ç¤ºè¡¨ç™½åŒºåŸŸ
        function showProposalSection() {
            const proposalSection = document.getElementById('proposalSection');
            const timerSection = document.getElementById('timerSection');
            
            if (proposalSection) proposalSection.classList.remove('hidden');
            if (timerSection) timerSection.classList.add('hidden');
        }

        // æ˜¾ç¤ºè®¡æ—¶å™¨åŒºåŸŸ
        function showTimerSection() {
            const proposalSection = document.getElementById('proposalSection');
            const timerSection = document.getElementById('timerSection');
            
            if (proposalSection) proposalSection.classList.add('hidden');
            if (timerSection) timerSection.classList.remove('hidden');
            
            // æ›´æ–°æ ‡é¢˜
            if (document.querySelector('#timerSection h2')) {
                document.querySelector('#timerSection h2').textContent = 
                    `${yourName}å’Œ${partnerName}å·²ç»ç›¸çˆ±äº†`;
            }
            
            // æ›´æ–°æ—¥æœŸæ˜¾ç¤º
            if (document.getElementById('loveDate')) {
                document.getElementById('loveDate').textContent = 
                    loveStartDate.toLocaleDateString('zh-CN');
            }
        }

        // å¼€å§‹çˆ±æƒ…è®¡æ—¶å™¨ï¼ˆè¡¨ç™½åŠŸèƒ½ï¼‰
        function startLoveTimer() {
            const yourNameInput = document.getElementById('yourName');
            const partnerNameInput = document.getElementById('partnerName');
            
            if (yourNameInput) yourName = yourNameInput.value.trim() || 'æˆ‘';
            if (partnerNameInput) partnerName = partnerNameInput.value.trim() || 'ä¹–ä¹–';
            
            // è®¾ç½®å½“å‰æ—¶é—´ä¸ºæ‹çˆ±å¼€å§‹æ—¶é—´
            loveStartDate = new Date();
            timerOffset = 0;
            
            // ä¿å­˜è®¾ç½®
            const settings = {
                loveStartDate: loveStartDate.toISOString(),
                yourName: yourName,
                partnerName: partnerName
            };
            localStorage.setItem('loveSiteSettings', JSON.stringify(settings));
            
            // åŒæ—¶ä¿å­˜åˆ°äº‘ç«¯
            if (dataSync) {
                dataSync.addItem('Setting', settings);
            }
            
            // æ›´æ–°çŠ¶æ€
            isTimerRunning = true;
            isTimerPaused = false;
            
            // æ˜¾ç¤ºæµªæ¼«åŠ¨ç”»
            showRomanticAnimation();
            
            // åˆ‡æ¢åˆ°è®¡æ—¶å™¨æ˜¾ç¤º
            setTimeout(() => {
                showTimerSection();
                startTimer();
                showNotification(`æ­å–œ${yourName}å’Œ${partnerName}ï¼ä½ ä»¬çš„çˆ±æƒ…è®¡æ—¶å™¨å·²å¼€å§‹ï¼`, 'success');
            }, 2000);
        }

        // æ˜¾ç¤ºæµªæ¼«åŠ¨ç”»
        function showRomanticAnimation() {
            // åˆ›å»ºå¿ƒå½¢çˆ†ç‚¸æ•ˆæœ
            for (let i = 0; i < 10; i++) {
                setTimeout(() => {
                    const heart = document.createElement('div');
                    heart.textContent = 'ğŸ’•';
                    heart.style.cssText = `
                        position: fixed;
                        left: ${Math.random() * 100}%;
                        top: ${Math.random() * 100}%;
                        font-size: ${Math.random() * 30 + 20}px;
                        pointer-events: none;
                        animation: heartExplosion 0.8s ease-out;
                        z-index: 10000;
                    `;
                    document.body.appendChild(heart);
                    
                    setTimeout(() => {
                        if (heart.parentNode) {
                            heart.parentNode.removeChild(heart);
                        }
                    }, 800);
                }, i * 100);
            }
            
            // åˆ›å»ºæ–‡å­—åŠ¨ç”»
            const text = document.createElement('div');
            text.className = 'fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-4xl md:text-6xl font-bold text-white animate-fadeInUp z-50 text-center';
            text.textContent = `â¤ï¸ ${yourName} â¤ï¸ ${partnerName} â¤ï¸`;
            text.style.textShadow = '0 0 30px rgba(255, 107, 157, 0.9)';
            text.style.animationDuration = '1s';
            document.body.appendChild(text);
            
            setTimeout(() => {
                if (text.parentNode) {
                    text.style.opacity = '0';
                    text.style.transition = 'opacity 2s ease-out';
                    setTimeout(() => {
                        if (text.parentNode) {
                            text.parentNode.removeChild(text);
                        }
                    }, 2000);
                }
            }, 3000);
        }

        // å¼€å§‹è®¡æ—¶å™¨
        function startTimer() {
            if (isTimerPaused || !isTimerRunning) return;
            
            timerInterval = setInterval(() => {
                updateTimer();
            }, 1000);
        }

        // æš‚åœè®¡æ—¶å™¨
        function pauseTimer() {
            if (!isTimerRunning || isTimerPaused) return;
            
            clearInterval(timerInterval);
            isTimerPaused = true;
            
            // æ›´æ–°æŒ‰é’®æ˜¾ç¤º
            document.getElementById('pauseBtn').classList.add('hidden');
            document.getElementById('resumeBtn').classList.remove('hidden');
            
            showNotification('çˆ±æƒ…è®¡æ—¶å™¨å·²æš‚åœ', 'info');
        }

        // ç»§ç»­è®¡æ—¶å™¨
        function resumeTimer() {
            if (!isTimerRunning || !isTimerPaused) return;
            
            isTimerPaused = false;
            startTimer();
            
            // æ›´æ–°æŒ‰é’®æ˜¾ç¤º
            document.getElementById('pauseBtn').classList.remove('hidden');
            document.getElementById('resumeBtn').classList.add('hidden');
            
            showNotification('çˆ±æƒ…è®¡æ—¶å™¨å·²ç»§ç»­', 'success');
        }

        // é‡ç½®è®¡æ—¶å™¨
        function resetTimer() {
            if (confirm('ç¡®å®šè¦é‡ç½®çˆ±æƒ…è®¡æ—¶å™¨å—ï¼Ÿè¿™å°†æ¸…é™¤æ‰€æœ‰è®°å½•ï¼')) {
                clearInterval(timerInterval);
                isTimerRunning = false;
                isTimerPaused = false;
                
                // æ¸…é™¤è®¾ç½®
                localStorage.removeItem('loveSiteSettings');
                
                // å¦‚æœæœ‰äº‘ç«¯åŒæ­¥ï¼Œä¹Ÿæ¸…é™¤äº‘ç«¯æ•°æ®
                if (dataSync) {
                    const settings = dataSync.getData('Setting');
                    settings.forEach(setting => {
                        dataSync.deleteItem('Setting', setting.id);
                    });
                }
                
                // é‡ç½®æ˜¾ç¤º
                document.getElementById('days').textContent = '0000';
                document.getElementById('hours').textContent = '00';
                document.getElementById('minutes').textContent = '00';
                document.getElementById('seconds').textContent = '00';
                
                // æ˜¾ç¤ºè¡¨ç™½ç•Œé¢
                showProposalSection();
                
                showNotification('çˆ±æƒ…è®¡æ—¶å™¨å·²é‡ç½®', 'warning');
            }
        }

        // æ›´æ–°è®¡æ—¶å™¨æ˜¾ç¤º
        function updateTimer() {
            if (!loveStartDate || isTimerPaused) return;
            
            const now = new Date();
            const diff = now - loveStartDate + timerOffset;
            
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);
            
            // æ›´æ–°æ˜¾ç¤º
            document.getElementById('days').textContent = days.toString().padStart(4, '0');
            document.getElementById('hours').textContent = hours.toString().padStart(2, '0');
            document.getElementById('minutes').textContent = minutes.toString().padStart(2, '0');
            document.getElementById('seconds').textContent = seconds.toString().padStart(2, '0');
            
            // ç‰¹æ®Šæ—¥æœŸæé†’
            if (seconds === 0 && minutes === 0 && hours === 0) {
                showNotification(`ğŸ‰ æ­å–œï¼ä½ ä»¬å·²ç»ç›¸çˆ±${days}å¤©äº†ï¼`, 'success');
            }
        }

        // åŠ è½½è®¾ç½®
        function loadSettings() {
            try {
                if (dataSync) {
                    const settings = dataSync.getData('Setting');
                    if (settings && settings.length > 0) {
                        const latestSetting = settings[0];
                        if (latestSetting.loveStartDate) {
                            loveStartDate = new Date(latestSetting.loveStartDate);
                            yourName = latestSetting.yourName || 'æˆ‘';
                            partnerName = latestSetting.partnerName || 'ä¹–ä¹–';
                        }
                    }
                }
            } catch (error) {
                console.error('Failed to load settings from sync:', error);
            }
        }

        // ç…§ç‰‡ç›¸å…³åŠŸèƒ½
        async function loadPhotos() {
            try {
                let photos = [];
                
                if (dataSync) {
                    photos = dataSync.getData('Photo') || [];
                } else {
                    // ä»æœ¬åœ°å­˜å‚¨åŠ è½½
                    const savedPhotos = localStorage.getItem('loveSitePhotos');
                    if (savedPhotos) {
                        photos = JSON.parse(savedPhotos);
                    }
                }
                
                renderPhotos(photos);
            } catch (error) {
                console.error('Failed to load photos:', error);
                showNotification('åŠ è½½ç…§ç‰‡å¤±è´¥', 'error');
            }
        }

        function renderPhotos(photos) {
            const grid = document.getElementById('photosGrid');
            if (!grid) return;
            
            if (photos.length === 0) {
                grid.innerHTML = `
                    <div class="text-center py-12 text-gray-500 col-span-full">
                        <i class="fa fa-picture-o text-4xl mb-4"></i>
                        <p>è¿˜æ²¡æœ‰ç…§ç‰‡ï¼Œå¿«å»ä¸Šä¼ ç¬¬ä¸€å¼ ç”œèœœå›å¿†å§ï¼</p>
                    </div>
                `;
                return;
            }
            
            grid.innerHTML = photos.map(photo => `
                <div class="relative group hover-lift animate-scaleIn">
                    <div class="aspect-square bg-gray-200 rounded-2xl overflow-hidden">
                        <img src="${photo.url}" alt="${photo.title || 'ç”œèœœå›å¿†'}" 
                             class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-110">
                    </div>
                    <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-50 transition-all duration-300 rounded-2xl flex items-center justify-center">
                        <div class="opacity-0 group-hover:opacity-100 transition-opacity duration-300 text-white">
                            <h4 class="font-bold mb-2">${photo.title || 'ç…§ç‰‡'}</h4>
                            <p class="text-sm mb-4">${photo.description || ''}</p>
                            <button onclick="deletePhoto('${photo.id}')" 
                                    class="delete-btn bg-red-500 text-white px-3 py-1 rounded-full text-xs">
                                <i class="fa fa-trash mr-1"></i>åˆ é™¤
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function openPhotoUpload() {
            const modal = `
                <div class="glass-card rounded-3xl p-8 max-w-md w-full animate-scaleIn">
                    <h3 class="text-2xl font-bold gradient-text mb-6 text-center">
                        <i class="fa fa-camera mr-3"></i>ä¸Šä¼ ç…§ç‰‡
                    </h3>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ç…§ç‰‡æ ‡é¢˜</label>
                            <input type="text" id="photoTitle" placeholder="ç»™ç…§ç‰‡èµ·ä¸ªåå­—..." 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ç…§ç‰‡æè¿°</label>
                            <textarea id="photoDescription" placeholder="æè¿°è¿™å¼ ç…§ç‰‡çš„æ•…äº‹..." 
                                      class="w-full px-4 py-3 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent h-24 resize-none"></textarea>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">é€‰æ‹©ç…§ç‰‡</label>
                            <input type="file" id="photoFile" accept="image/*" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                            <p class="text-xs text-gray-500 mt-1">æ”¯æŒJPGã€PNGç­‰æ ¼å¼ï¼Œæœ€å¤§5MB</p>
                        </div>
                        
                        <div class="flex space-x-4 pt-4">
                            <button onclick="closeModal()" 
                                    class="flex-1 px-6 py-3 bg-gray-500 text-white rounded-full hover:bg-gray-600 transition-colors duration-300">
                                å–æ¶ˆ
                            </button>
                            <button onclick="uploadPhoto()" 
                                    class="flex-1 px-6 py-3 bg-primary text-white rounded-full hover:bg-secondary transition-colors duration-300">
                                ä¸Šä¼ 
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            openModal(modal);
        }

        async function uploadPhoto() {
            const title = document.getElementById('photoTitle').value.trim();
            const description = document.getElementById('photoDescription').value.trim();
            const fileInput = document.getElementById('photoFile');
            
            if (!fileInput.files || fileInput.files.length === 0) {
                showNotification('è¯·é€‰æ‹©ä¸€å¼ ç…§ç‰‡', 'warning');
                return;
            }
            
            const file = fileInput.files[0];
            
            // æ£€æŸ¥æ–‡ä»¶å¤§å°
            if (file.size > 5 * 1024 * 1024) { // 5MB
                showNotification('ç…§ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡5MB', 'error');
                return;
            }
            
            try {
                showNotification('æ­£åœ¨ä¸Šä¼ ç…§ç‰‡...', 'info');
                
                // ä¸Šä¼ æ–‡ä»¶
                const uploadResult = await dataSync.uploadFile(file);
                if (!uploadResult) {
                    throw new Error('ä¸Šä¼ å¤±è´¥');
                }
                
                // åˆ›å»ºç…§ç‰‡å¯¹è±¡
                const photo = {
                    title: title,
                    description: description,
                    url: uploadResult.url,
                    timestamp: new Date().toISOString()
                };
                
                // ä¿å­˜åˆ°æ•°æ®åŒæ­¥
                await dataSync.addItem('Photo', photo);
                
                // é‡æ–°åŠ è½½ç…§ç‰‡
                loadPhotos();
                
                closeModal();
                showNotification('ç…§ç‰‡ä¸Šä¼ æˆåŠŸï¼', 'success');
                
            } catch (error) {
                console.error('Failed to upload photo:', error);
                showNotification(`ç…§ç‰‡ä¸Šä¼ å¤±è´¥ï¼š${error.message}`, 'error');
            }
        }

        async function deletePhoto(id) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™å¼ ç…§ç‰‡å—ï¼Ÿ')) {
                try {
                    await dataSync.deleteItem('Photo', id);
                    loadPhotos();
                    showNotification('ç…§ç‰‡åˆ é™¤æˆåŠŸï¼', 'success');
                } catch (error) {
                    console.error('Failed to delete photo:', error);
                    showNotification('åˆ é™¤ç…§ç‰‡å¤±è´¥', 'error');
                }
            }
        }

        // æ—¥è®°ç›¸å…³åŠŸèƒ½
        async function loadDiary() {
            try {
                let diary = [];
                
                if (dataSync) {
                    diary = dataSync.getData('Diary') || [];
                } else {
                    // ä»æœ¬åœ°å­˜å‚¨åŠ è½½
                    const savedDiary = localStorage.getItem('loveSiteDiary');
                    if (savedDiary) {
                        diary = JSON.parse(savedDiary);
                    }
                }
                
                // æŒ‰æ—¥æœŸæ’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
                diary.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                renderDiary(diary);
            } catch (error) {
                console.error('Failed to load diary:', error);
                showNotification('åŠ è½½æ—¥è®°å¤±è´¥', 'error');
            }
        }

        function renderDiary(diary) {
            const container = document.getElementById('diaryEntries');
            if (!container) return;
            
            if (diary.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12 text-gray-500">
                        <i class="fa fa-edit text-4xl mb-4"></i>
                        <p>è¿˜æ²¡æœ‰æ—¥è®°ï¼Œå¿«å»è®°å½•ä½ ä»¬çš„çˆ±æƒ…æ•…äº‹å§ï¼</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = diary.map(entry => `
                <div class="glass-effect rounded-2xl p-6 hover-lift animate-fadeInUp">
                    <div class="flex items-center justify-between mb-4">
                        <h4 class="text-xl font-bold text-primary">${entry.title}</h4>
                        <span class="text-sm text-gray-500">${new Date(entry.date).toLocaleDateString('zh-CN')}</span>
                    </div>
                    <div class="text-gray-700 leading-relaxed mb-4">${entry.content.replace(/\n/g, '<br>')}</div>
                    <div class="flex justify-end">
                        <button onclick="deleteDiary('${entry.id}')" 
                                class="delete-btn bg-red-500 text-white px-4 py-2 rounded-full text-sm">
                            <i class="fa fa-trash mr-1"></i>åˆ é™¤
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function openDiaryEditor() {
            const modal = `
                <div class="glass-card rounded-3xl p-8 max-w-2xl w-full max-h-[90vh] overflow-y-auto animate-scaleIn">
                    <h3 class="text-2xl font-bold gradient-text mb-6 text-center">
                        <i class="fa fa-book mr-3"></i>å†™æ—¥è®°
                    </h3>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">æ—¥è®°æ ‡é¢˜</label>
                            <input type="text" id="diaryTitle" placeholder="ç»™æ—¥è®°èµ·ä¸ªæ ‡é¢˜..." 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">æ—¥æœŸ</label>
                            <input type="date" id="diaryDate" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">æ—¥è®°å†…å®¹</label>
                            <textarea id="diaryContent" placeholder="è®°å½•ä»Šå¤©çš„å¿ƒæƒ…å’Œæ•…äº‹..." 
                                      class="w-full px-4 py-3 border border-gray-300 rounded-2xl focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent h-64 resize-none"></textarea>
                        </div>
                        
                        <div class="flex space-x-4 pt-4">
                            <button onclick="closeModal()" 
                                    class="flex-1 px-6 py-3 bg-gray-500 text-white rounded-full hover:bg-gray-600 transition-colors duration-300">
                                å–æ¶ˆ
                            </button>
                            <button onclick="saveDiary()" 
                                    class="flex-1 px-6 py-3 bg-primary text-white rounded-full hover:bg-secondary transition-colors duration-300">
                                ä¿å­˜
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            openModal(modal);
        }

        async function saveDiary() {
            const title = document.getElementById('diaryTitle').value.trim();
            const date = document.getElementById('diaryDate').value;
            const content = document.getElementById('diaryContent').value.trim();
            
            if (!title) {
                showNotification('è¯·è¾“å…¥æ—¥è®°æ ‡é¢˜', 'warning');
                return;
            }
            
            if (!date) {
                showNotification('è¯·é€‰æ‹©æ—¥æœŸ', 'warning');
                return;
            }
            
            if (!content) {
                showNotification('è¯·è¾“å…¥æ—¥è®°å†…å®¹', 'warning');
                return;
            }
            
            try {
                const diaryEntry = {
                    title: title,
                    date: date,
                    content: content,
                    timestamp: new Date().toISOString()
                };
                
                await dataSync.addItem('Diary', diaryEntry);
                loadDiary();
                closeModal();
                showNotification('æ—¥è®°ä¿å­˜æˆåŠŸï¼', 'success');
                
            } catch (error) {
                console.error('Failed to save diary:', error);
                showNotification('ä¿å­˜æ—¥è®°å¤±è´¥', 'error');
            }
        }

        async function deleteDiary(id) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ç¯‡æ—¥è®°å—ï¼Ÿ')) {
                try {
                    await dataSync.deleteItem('Diary', id);
                    loadDiary();
                    showNotification('æ—¥è®°åˆ é™¤æˆåŠŸï¼', 'success');
                } catch (error) {
                    console.error('Failed to delete diary:', error);
                    showNotification('åˆ é™¤æ—¥è®°å¤±è´¥', 'error');
                }
            }
        }

        // ç•™è¨€ç›¸å…³åŠŸèƒ½
        async function loadMessages() {
            try {
                let messages = [];
                
                if (dataSync) {
                    messages = dataSync.getData('Message') || [];
                } else {
                    // ä»æœ¬åœ°å­˜å‚¨åŠ è½½
                    const savedMessages = localStorage.getItem('loveSiteMessages');
                    if (savedMessages) {
                        messages = JSON.parse(savedMessages);
                    }
                }
                
                // æŒ‰æ—¶é—´æ’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
                messages.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                renderMessages(messages);
            } catch (error) {
                console.error('Failed to load messages:', error);
                showNotification('åŠ è½½ç•™è¨€å¤±è´¥', 'error');
            }
        }

        function renderMessages(messages) {
            const container = document.getElementById('messagesList');
            if (!container) return;
            
            if (messages.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12 text-gray-500">
                        <i class="fa fa-comment text-4xl mb-4"></i>
                        <p>è¿˜æ²¡æœ‰ç•™è¨€ï¼Œå¿«å»ç»™TAä¸€ä¸ªæƒŠå–œå§ï¼</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = messages.map(msg => `
                <div class="glass-effect rounded-2xl p-4 animate-fadeInUp">
                    <div class="flex items-start justify-between mb-2">
                        <span class="font-bold text-primary">${msg.sender}</span>
                        <span class="text-xs text-gray-500">${new Date(msg.timestamp).toLocaleString('zh-CN')}</span>
                    </div>
                    <div class="text-gray-700 mb-3">${msg.content}</div>
                    <div class="flex items-center space-x-4">
                        <button onclick="likeMessage('${msg.id}')" 
                                class="text-orange-500 hover:text-orange-600 transition-colors duration-300 text-sm">
                            <i class="fa fa-heart mr-1"></i>å–œæ¬¢ (${msg.likes || 0})
                        </button>
                        <button onclick="deleteMessage('${msg.id}')" 
                                class="text-red-500 hover:text-red-600 transition-colors duration-300 text-sm">
                            <i class="fa fa-trash mr-1"></i>åˆ é™¤
                        </button>
                    </div>
                </div>
            `).join('');
        }

        async function sendMessage() {
            const sender = document.getElementById('messageSender').value.trim();
            const content = document.getElementById('messageContent').value.trim();
            
            if (!sender) {
                showNotification('è¯·è¾“å…¥ä½ çš„æ˜µç§°', 'warning');
                return;
            }
            
            if (!content) {
                showNotification('è¯·è¾“å…¥ç•™è¨€å†…å®¹', 'warning');
                return;
            }
            
            try {
                const message = {
                    sender: sender,
                    content: content,
                    timestamp: new Date().toISOString(),
                    likes: 0
                };
                
                await dataSync.addItem('Message', message);
                
                // æ¸…ç©ºè¾“å…¥æ¡†
                document.getElementById('messageContent').value = '';
                
                // é‡æ–°åŠ è½½ç•™è¨€
                loadMessages();
                
                showNotification('ç•™è¨€å‘é€æˆåŠŸï¼', 'success');
                
            } catch (error) {
                console.error('Failed to send message:', error);
                showNotification('å‘é€ç•™è¨€å¤±è´¥', 'error');
            }
        }

        async function likeMessage(id) {
            try {
                const messages = dataSync.getData('Message');
                const message = messages.find(m => m.id === id);
                
                if (message) {
                    message.likes = (message.likes || 0) + 1;
                    await dataSync.updateItem('Message', id, message);
                    loadMessages();
                    showNotification('ç‚¹èµæˆåŠŸï¼', 'success');
                }
                
            } catch (error) {
                console.error('Failed to like message:', error);
                showNotification('ç‚¹èµå¤±è´¥', 'error');
            }
        }

        async function deleteMessage(id) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡ç•™è¨€å—ï¼Ÿ')) {
                try {
                    await dataSync.deleteItem('Message', id);
                    loadMessages();
                    showNotification('ç•™è¨€åˆ é™¤æˆåŠŸï¼', 'success');
                } catch (error) {
                    console.error('Failed to delete message:', error);
                    showNotification('åˆ é™¤ç•™è¨€å¤±è´¥', 'error');
                }
            }
        }

        // çºªå¿µæ—¥ç›¸å…³åŠŸèƒ½
        async function loadAnniversaries() {
            try {
                let anniversaries = [];
                
                if (dataSync) {
                    anniversaries = dataSync.getData('Anniversary') || [];
                } else {
                    // ä»æœ¬åœ°å­˜å‚¨åŠ è½½
                    const savedAnniversaries = localStorage.getItem('loveSiteAnniversaries');
                    if (savedAnniversaries) {
                        anniversaries = JSON.parse(savedAnniversaries);
                    }
                }
                
                // è®¡ç®—å€’è®¡æ—¶å¹¶æ’åº
                anniversaries.forEach(anniv => {
                    const nextDate = getNextAnniversaryDate(anniv.date);
                    const now = new Date();
                    anniv.daysLeft = Math.ceil((nextDate - now) / (1000 * 60 * 60 * 24));
                });
                
                // æŒ‰å€’è®¡æ—¶æ’åºï¼ˆæœ€è¿‘çš„åœ¨å‰ï¼‰
                anniversaries.sort((a, b) => a.daysLeft - b.daysLeft);
                
                renderAnniversaries(anniversaries);
            } catch (error) {
                console.error('Failed to load anniversaries:', error);
                showNotification('åŠ è½½çºªå¿µæ—¥å¤±è´¥', 'error');
            }
        }

        function getNextAnniversaryDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const nextDate = new Date(now.getFullYear(), date.getMonth(), date.getDate());
            
            if (nextDate < now) {
                nextDate.setFullYear(nextDate.getFullYear() + 1);
            }
            
            return nextDate;
        }

        function renderAnniversaries(anniversaries) {
            const grid = document.getElementById('anniversariesGrid');
            if (!grid) return;
            
            if (anniversaries.length === 0) {
                grid.innerHTML = `
                    <div class="text-center py-12 text-gray-500 col-span-full">
                        <i class="fa fa-calendar text-4xl mb-4"></i>
                        <p>è¿˜æ²¡æœ‰çºªå¿µæ—¥ï¼Œå¿«å»æ·»åŠ é‡è¦çš„æ—¥å­å§ï¼</p>
                    </div>
                `;
                return;
            }
            
            const icons = {
                'love': 'ğŸ’•',
                'birthday': 'ğŸ‚',
                'meeting': 'ğŸ’',
                'travel': 'âœˆï¸',
                'holiday': 'ğŸ‰',
                'other': 'â­'
            };
            
            grid.innerHTML = anniversaries.map(anniv => `
                <div class="glass-effect rounded-2xl p-6 hover-lift animate-scaleIn">
                    <div class="text-4xl mb-4">${icons[anniv.icon] || 'â­'}</div>
                    <h4 class="text-xl font-bold text-primary mb-2">${anniv.title}</h4>
                    <p class="text-gray-600 mb-4">${new Date(anniv.date).toLocaleDateString('zh-CN')}</p>
                    <div class="bg-primary bg-opacity-10 rounded-full px-4 py-2 text-center">
                        <span class="text-primary font-bold">${anniv.daysLeft}</span>å¤©å
                    </div>
                    <div class="flex justify-end mt-4">
                        <button onclick="deleteAnniversary('${anniv.id}')" 
                                class="delete-btn bg-red-500 text-white px-4 py-2 rounded-full text-sm">
                            <i class="fa fa-trash mr-1"></i>åˆ é™¤
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function openAnniversaryEditor() {
            const modal = `
                <div class="glass-card rounded-3xl p-8 max-w-md w-full animate-scaleIn">
                    <h3 class="text-2xl font-bold gradient-text mb-6 text-center">
                        <i class="fa fa-star mr-3"></i>æ·»åŠ çºªå¿µæ—¥
                    </h3>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">çºªå¿µæ—¥åç§°</label>
                            <input type="text" id="anniversaryTitle" placeholder="ä¾‹å¦‚ï¼šç¬¬ä¸€æ¬¡çº¦ä¼š" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">æ—¥æœŸ</label>
                            <input type="date" id="anniversaryDate" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">é€‰æ‹©å›¾æ ‡</label>
                            <div class="grid grid-cols-6 gap-2">
                                <button onclick="selectAnniversaryIcon('love')" class="anniversary-icon-btn p-2 border-2 border-transparent rounded-full hover:border-primary transition-colors duration-300">ğŸ’•</button>
                                <button onclick="selectAnniversaryIcon('birthday')" class="anniversary-icon-btn p-2 border-2 border-transparent rounded-full hover:border-primary transition-colors duration-300">ğŸ‚</button>
                                <button onclick="selectAnniversaryIcon('meeting')" class="anniversary-icon-btn p-2 border-2 border-transparent rounded-full hover:border-primary transition-colors duration-300">ğŸ’</button>
                                <button onclick="selectAnniversaryIcon('travel')" class="anniversary-icon-btn p-2 border-2 border-transparent rounded-full hover:border-primary transition-colors duration-300">âœˆï¸</button>
                                <button onclick="selectAnniversaryIcon('holiday')" class="anniversary-icon-btn p-2 border-2 border-transparent rounded-full hover:border-primary transition-colors duration-300">ğŸ‰</button>
                                <button onclick="selectAnniversaryIcon('other')" class="anniversary-icon-btn p-2 border-2 border-transparent rounded-full hover:border-primary transition-colors duration-300">â­</button>
                            </div>
                        </div>
                        
                        <div class="flex space-x-4 pt-4">
                            <button onclick="closeModal()" 
                                    class="flex-1 px-6 py-3 bg-gray-500 text-white rounded-full hover:bg-gray-600 transition-colors duration-300">
                                å–æ¶ˆ
                            </button>
                            <button onclick="saveAnniversary()" 
                                    class="flex-1 px-6 py-3 bg-primary text-white rounded-full hover:bg-secondary transition-colors duration-300">
                                ä¿å­˜
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            openModal(modal);
            
            // æ·»åŠ å›¾æ ‡é€‰æ‹©æ ·å¼
            const style = document.createElement('style');
            style.textContent = `
                .anniversary-icon-btn {
                    font-size: 1.5rem;
                    cursor: pointer;
                }
                .anniversary-icon-btn.selected {
                    border-color: #FF6B9D;
                    background: rgba(255, 107, 157, 0.1);
                }
            `;
            document.head.appendChild(style);
        }

        let selectedAnniversaryIcon = 'love';

        function selectAnniversaryIcon(icon) {
            selectedAnniversaryIcon = icon;
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.anniversary-icon-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            event.target.classList.add('selected');
        }

        async function saveAnniversary() {
            const title = document.getElementById('anniversaryTitle').value.trim();
            const date = document.getElementById('anniversaryDate').value;
            
            if (!title) {
                showNotification('è¯·è¾“å…¥çºªå¿µæ—¥åç§°', 'warning');
                return;
            }
            
            if (!date) {
                showNotification('è¯·é€‰æ‹©æ—¥æœŸ', 'warning');
                return;
            }
            
            try {
                const anniversary = {
                    title: title,
                    date: date,
                    icon: selectedAnniversaryIcon,
                    timestamp: new Date().toISOString()
                };
                
                await dataSync.addItem('Anniversary', anniversary);
                loadAnniversaries();
                closeModal();
                showNotification('çºªå¿µæ—¥æ·»åŠ æˆåŠŸï¼', 'success');
                
            } catch (error) {
                console.error('Failed to save anniversary:', error);
                showNotification('ä¿å­˜çºªå¿µæ—¥å¤±è´¥', 'error');
            }
        }

        async function deleteAnniversary(id) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªçºªå¿µæ—¥å—ï¼Ÿ')) {
                try {
                    await dataSync.deleteItem('Anniversary', id);
                    loadAnniversaries();
                    showNotification('çºªå¿µæ—¥åˆ é™¤æˆåŠŸï¼', 'success');
                } catch (error) {
                    console.error('Failed to delete anniversary:', error);
                    showNotification('åˆ é™¤çºªå¿µæ—¥å¤±è´¥', 'error');
                }
            }
        }

        // æ¨¡æ€æ¡†åŠŸèƒ½
        function openModal(content) {
            const container = document.getElementById('modalContainer');
            if (!container) return;
            
            container.innerHTML = content;
            container.classList.remove('hidden');
            container.classList.add('flex');
            
            // ç‚¹å‡»èƒŒæ™¯å…³é—­æ¨¡æ€æ¡†
            container.onclick = function(e) {
                if (e.target === container) {
                    closeModal();
                }
            };
        }

        function closeModal() {
            const container = document.getElementById('modalContainer');
            if (!container) return;
            
            container.classList.add('hidden');
            container.classList.remove('flex');
            container.innerHTML = '';
        }

        // é€šçŸ¥åŠŸèƒ½
        function showNotification(message, type = 'info') {
            const container = document.getElementById('notificationContainer');
            if (!container) return;
            
            const notification = document.createElement('div');
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                warning: 'bg-yellow-500',
                info: 'bg-blue-500'
            };
            
            const icons = {
                success: 'fa-check-circle',
                error: 'fa-times-circle',
                warning: 'fa-exclamation-triangle',
                info: 'fa-info-circle'
            };
            
            notification.className = `${colors[type]} text-white px-4 py-3 rounded-lg shadow-lg animate-fadeInUp`;
            notification.innerHTML = `
                <div class="flex items-center space-x-2">
                    <i class="fa ${icons[type]}"></i>
                    <span>${message}</span>
                </div>
            `;
            
            container.appendChild(notification);
            
            // 3ç§’åè‡ªåŠ¨ç§»é™¤
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                notification.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
                
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // ä¸»é¢˜åˆ‡æ¢åŠŸèƒ½
        function toggleTheme() {
            const body = document.body;
            const isDark = body.classList.toggle('dark-theme');
            
            if (isDark) {
                body.style.background = 'linear-gradient(135deg, #1a1a2e 0%, #16213e 100%)';
            } else {
                body.style.background = 'linear-gradient(135deg, #FFF0F5 0%, #FFE4E6 100%)';
            }
            
            showNotification(isDark ? 'æš—è‰²ä¸»é¢˜å·²å¯ç”¨' : 'äº®è‰²ä¸»é¢˜å·²å¯ç”¨', 'info');
        }

        // é”®ç›˜å¿«æ·é”®
        document.addEventListener('keydown', function(e) {
            // ESCé”®å…³é—­æ¨¡æ€æ¡†
            if (e.key === 'Escape') {
                closeModal();
            }
            
            // Ctrl+S ä¿å­˜å½“å‰ç¼–è¾‘
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                if (currentTab === 'diary') {
                    saveDiary();
                }
            }
            
            // Ctrl+N æ–°å»º
            if (e.ctrlKey && e.key === 'n') {
                e.preventDefault();
                switch (currentTab) {
                    case 'photos':
                        openPhotoUpload();
                        break;
                    case 'diary':
                        openDiaryEditor();
                        break;
                    case 'anniversaries':
                        openAnniversaryEditor();
                        break;
                }
            }
        });

        // è‡ªåŠ¨ä¿å­˜åŠŸèƒ½
        setInterval(() => {
            try {
                if (dataSync && dataSync.syncAllData) {
                    // æ¯5åˆ†é’Ÿè‡ªåŠ¨åŒæ­¥ä¸€æ¬¡
                    dataSync.syncAllData();
                }
            } catch (error) {
                console.error('Auto-sync failed:', error);
            }
        }, 5 * 60 * 1000);

        // é¡µé¢å¯è§æ€§å˜åŒ–æ—¶åŒæ­¥æ•°æ®
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden && dataSync && dataSync.syncAllData) {
                dataSync.syncAllData();
            }
        });

        // ç½‘ç»œçŠ¶æ€å˜åŒ–æ—¶åŒæ­¥æ•°æ®
        window.addEventListener('online', function() {
            if (dataSync && dataSync.syncAllData) {
                dataSync.syncAllData();
                showNotification('ç½‘ç»œå·²æ¢å¤ï¼Œæ­£åœ¨åŒæ­¥æ•°æ®...', 'info');
            }
        });

        // é¡µé¢å¸è½½æ—¶ä¿å­˜æ•°æ®
        window.addEventListener('beforeunload', function() {
            try {
                if (dataSync && dataSync.syncAllData) {
                    dataSync.syncAllData();
                }
            } catch (error) {
                console.error('Pre-unload sync failed:', error);
            }
        });
    </script>
</body>
</html>